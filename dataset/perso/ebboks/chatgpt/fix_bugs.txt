DECLARE
   TYPE BLOK_TRADE IS TABLE OF tbl_md_blocktrade%ROWTYPE;
   l_BLOK_TRADE  BLOK_TRADE;
   V_BLOK_TRADE tbl_md_blocktrade%ROWTYPE;
BEGIN
   FOR Cursor_orderRef IN (SELECT DISTINCT ord.ul_id FROM tblorders ord WHERE ord.ul_id = 'RE1a44d5290000') LOOP
      DBMS_OUTPUT.PUT_LINE('Le numéro de son ordre est ' || Cursor_orderRef.ul_id);
      SELECT * BULK COLLECT INTO l_BLOK_TRADE FROM tbl_md_blocktrade WHERE refs LIKE '%type="order" refid="' || Cursor_orderRef.ul_id || '%';

      FOR indx IN 1 .. l_BLOK_TRADE.COUNT LOOP
         V_BLOK_TRADE := l_BLOK_TRADE(indx);
         DBMS_OUTPUT.PUT_LINE('ordre ul_id: ' || Cursor_orderRef.ul_id || ', locktrade UL_ID:' || V_BLOK_TRADE.ul_id || ', INSTRUMENTID:' || V_BLOK_TRADE.INSTRUMENTID);
      END LOOP;
   END LOOP;
END;
/

DECLARE
   TYPE ResultatType IS RECORD (
      ordre_ul_id         VARCHAR2(100),
      locktrade_ul_id     VARCHAR2(100),
      instrumentid        VARCHAR2(100)
   );
   
   TYPE ResultatTableType IS TABLE OF ResultatType;
   ResultatTable ResultatTableType := ResultatTableType();

   i INTEGER := 1;
BEGIN
   FOR rec IN (SELECT DISTINCT ord.ul_id, blktrd.ul_id AS locktrade_ul_id, blktrd.instrumentid
               FROM tblorders ord
               JOIN tbl_md_blocktrade blktrd ON blktrd.refs LIKE '%type="order" refid="' || ord.ul_id || '%'
               WHERE ord.ul_id = 'RE1a44d5290000')
   LOOP
      ResultatTable.EXTEND;
      ResultatTable(i).ordre_ul_id := rec.ul_id;
      ResultatTable(i).locktrade_ul_id := rec.locktrade_ul_id;
      ResultatTable(i).instrumentid := rec.instrumentid;
      i := i + 1;
   END LOOP;

   -- Utilisation des résultats
   FOR j IN 1 .. ResultatTable.COUNT LOOP
      DBMS_OUTPUT.PUT_LINE('Le numéro de son ordre est ' || ResultatTable(j).ordre_ul_id);
      DBMS_OUTPUT.PUT_LINE('ordre ul_id: ' || ResultatTable(j).ordre_ul_id || ', locktrade UL_ID:' || ResultatTable(j).locktrade_ul_id || ', INSTRUMENTID:' || ResultatTable(j).instrumentid);
   END LOOP;
   
   -- Retourner les résultats
   FOR k IN 1 .. ResultatTable.COUNT LOOP
      -- Utilisez les valeurs de ResultatTable(k) pour traiter les résultats comme nécessaire
      -- Par exemple, insérer les résultats dans une autre table, les utiliser dans une autre requête, etc.
      -- Ici, nous utilisons DBMS_OUTPUT.PUT_LINE pour afficher les résultats à titre d'exemple
      DBMS_OUTPUT.PUT_LINE('Le numéro de son ordre est ' || ResultatTable(k).ordre_ul_id);
      DBMS_OUTPUT.PUT_LINE('ordre ul_id: ' || ResultatTable(k).ordre_ul_id || ', locktrade UL_ID:' || ResultatTable(k).locktrade_ul_id || ', INSTRUMENTID:' || ResultatTable(k).instrumentid);
   END LOOP;
END;
/

Unicode String could not be converted to a Single-Byte

select PRD.PRODUCT_KEY,
    PRD.PRODUCT_NAME,CONVERT(PRD.PRODUCT_NAME,'UTF8','us7ascii'),
    PRD.PRODUCT_TYPE_CD,
    PRD.LAST_UPDATE_DATE,
    PRODUCT_SUB_TYPE_CD 
from SAM_PRF_ST_PRD PRD,  
    SAM_PRF_LE_ACT_SEG SEG,
    SAM_PRF_AGG_TRD_TMP2 TRD
    WHERE SEG.SEGMENT = 1 
    AND CONVERT(PRD.PRODUCT_NAME,'UTF8','us7ascii') <> PRD.PRODUCT_NAME
    AND IS_FOR_DETECTION = '1'  
    AND TRD.DAY_SK BETWEEN 8564 AND 8565 
    AND TRD.PRODUCT_SK = PRD.PRODUCT_SK
    AND SEG.ACCOUNT_KEY = TRD.ENTITY_KEY
    AND 1=1
    order by PRD.PRODUCT_KEY

" Hervé,

Nus avosn eu récemment un probleme en preproduction et en production avec les produits."

De ton coté, peux-tu voir dans la journée avec l’ETL, le problème d’encodage des product ; Je crains que l’on soit réalimenté wrongly aux prochains batchs…
•	Savoir si ça va être récurrent ou si c’était juste 1 fois.
•	Identifier la rootCause. Est-ce que ça vient de l’ETL ou est-ce que ça vient des fichiers CBG.

Cher Hervé,

J'espère que tu vas bien. Nous avons récemment rencontré un problème en préproduction et en production concernant les produits, et j'aimerais bénéficier de ton expertise en tant que membre de l'équipe ETL pour nous aider à résoudre cette situation.

Il semblerait que nous ayons des problèmes d'encodage des produits lors de la réalimentation des prochains lots de données. Je suis préoccupé par la possibilité que cela se reproduise à l'avenir, et nous souhaiterions identifier la cause profonde de ce problème. Est-ce que cela provient de l'ETL ou est-ce que cela est lié aux fichiers CBG que nous utilisons ?

Serait-il possible pour toi de prendre un moment aujourd'hui pour investiguer ce problème d'encodage des produits avec l'équipe ETL ? Je te serais reconnaissant de nous aider à répondre aux questions suivantes :

Est-ce que ce problème d'encodage est susceptible de se reproduire de manière récurrente ou était-ce un incident isolé ?
Peux-tu nous aider à identifier la cause racine de ce problème ? Est-ce que cela provient de l'ETL ou est-ce lié aux fichiers CBG ?
Ton expertise et tes efforts pour résoudre cette situation sont grandement appréciés. N'hésite pas à me tenir au courant des résultats de tes investigations et à me contacter si tu as besoin de plus d'informations.

Merci beaucoup pour ton aide et ta collaboration.

Bien cordialement,
[Votre nom]


